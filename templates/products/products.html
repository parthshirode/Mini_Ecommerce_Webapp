{% extends 'base.html' %}

{% block title %}Manage Products{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="p-4 mb-4 text-sm rounded-lg {% if category == 'error' %}bg-red-900 text-red-300{% else %}bg-green-900 text-green-300{% endif %}" role="alert">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="space-y-12">
        
        <!-- Add/Edit Product Form Section -->
        {% if session.logged_in and session.user.Role in ['admin', 'seller'] %}
        <div class="max-w-2xl mx-auto">
            <div class="glass-card rounded-xl p-6">
                <h2 class="text-2xl font-bold text-white mb-4">
                    {% if product_to_edit %}
                        <i class="fas fa-edit text-violet-400 mr-2"></i>Edit Product
                    {% else %}
                        <i class="fas fa-plus-circle text-violet-400 mr-2"></i>Add New Product
                    {% endif %}
                </h2>
                
                <form action="{{ url_for('products.edit_product', product_id=product_to_edit.ProductID) if product_to_edit else url_for('products.all_products') }}" method="POST" class="space-y-4">
                    
                    <input type="hidden" name="add_product" value="true">

                    <div>
                        <label for="name" class="block mb-2 text-sm font-medium text-gray-300">Product Name</label>
                        <input type="text" name="name" id="name" value="{{ product_to_edit.Name if product_to_edit else '' }}" class="bg-gray-900/50 border border-gray-700 text-gray-300 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5" placeholder="e.g., Laptop Pro" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="price" class="block mb-2 text-sm font-medium text-gray-300">Price (₹)</label>
                            <input type="number" name="price" id="price" value="{{ product_to_edit.Price if product_to_edit else '' }}" step="0.01" class="bg-gray-900/50 border border-gray-700 text-gray-300 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5" placeholder="e.g., 95599.00" required>
                        </div>
                        <div>
                            <label for="stock" class="block mb-2 text-sm font-medium text-gray-300">Stock</label>
                            <input type="number" name="stock" id="stock" value="{{ product_to_edit.Stock if product_to_edit else '' }}" class="bg-gray-900/50 border border-gray-700 text-gray-300 text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5" placeholder="e.g., 50" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full aurora-btn font-bold">
                        {% if product_to_edit %}Update Product{% else %}Save Product{% endif %}
                    </button>
                    {% if product_to_edit %}
                    <a href="{{ url_for('products.all_products') }}" class="block text-center mt-2 text-gray-400 hover:text-violet-300 transition-colors text-sm">Cancel Edit</a>
                    {% endif %}
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Products List Section -->
        <div>
            <h2 class="text-3xl font-bold text-white mb-6 px-2">
                {% if session.logged_in and session.user.Role in ['admin', 'seller'] %}
                    Your Products
                {% else %}
                    Discover Our Products
                {% endif %}
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                 {% for product in products %}
                 <div class="glass-card rounded-xl p-4 flex flex-col group">
                    <!-- Product Image Placeholder -->
                    <div class="relative w-full h-48 bg-gray-900/50 rounded-lg flex items-center justify-center mb-4 overflow-hidden">
                        <i class="fas fa-box text-6xl text-violet-400/50 transition-transform duration-300 group-hover:scale-110 group-hover:text-violet-400"></i>
                    </div>

                    <!-- Product Details -->
                    <div class="flex-grow">
                        <h3 class="font-bold text-lg text-white truncate">{{ product.Name }}</h3>
                        <p class="text-sm text-gray-400">Stock: {{ product.Stock }}</p>
                    </div>

                    <!-- Price and Actions -->
                    <div class="mt-4">
                        <p class="text-2xl font-bold text-violet-300 mb-3">₹{{ "%.2f"|format(product.Price) }}</p>
                        
                        <!-- Action Buttons based on User Role -->
                        {% if session.logged_in %}
                            {% if session.user.Role == 'customer' %}
                                <form action="{{ url_for('orders.add_to_cart', product_id=product.ProductID) }}" method="post" class="w-full">
                                    <button type="submit" class="w-full aurora-btn btn-sm">
                                        <i class="fas fa-cart-plus mr-2"></i>Add to Cart
                                    </button>
                                </form>
                            {% elif session.user.Role == 'admin' or session.user.UserID == product.SellerID %}
                                <div class="flex items-center justify-between space-x-2">
                                    <a href="{{ url_for('products.all_products', edit=product.ProductID) }}" class="flex-1 text-center aurora-btn btn-edit btn-sm">Edit</a>
                                    <form action="{{ url_for('products.delete_product', product_id=product.ProductID) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this product?');" class="flex-1">
                                        <button type="submit" class="w-full aurora-btn btn-delete btn-sm">Delete</button>
                                    </form>
                                </div>
                            {% endif %}
                        {% else %}
                             <a href="{{ url_for('users.login') }}" class="block w-full text-center aurora-btn btn-sm">Login to Purchase</a>
                        {% endif %}
                    </div>
                 </div>
                 {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

